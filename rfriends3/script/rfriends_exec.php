<?php
 function gogaku_wait() { global $radiru_gogaku_url; $url = $radiru_gogaku_url; for ($i=0;$i<10;$i++) { $html = rf_get_html($url,1); if ($html !== false) break; $wn = rand(10,30); echo_prn(1, "wait $wn sec"); sleep($wn); } } function rfriends_exec_run($nam) { global $tmpdir; $run = ".trun"; $can = ".tcan"; $fn = make_fn($nam); rf_touch($tmpdir.$fn.$run); return $fn; } function rfriends_exec_end($fn) { global $tmpdir; $run = ".trun"; $can = ".tcan"; fin_unlink($tmpdir.$fn.$run); fin_unlink($tmpdir.$fn.$can); return; } function rfriends_exec_glob($nam) { $run = ".trun"; $can = ".tcan"; global $tmpdir; $names_run = glob($tmpdir.$nam."_*".$run); if ($names_run === false) return false; $tsk = array(); foreach($names_run as $nm) { $fn = basename($nm,$run); if (file_exists($tmpdir.$fn.$can)) { $cn = true; } else { $cn = false; } $tsk = array($fn,$cn); } return $tsk; } function rfriends_exec_can($fn) { $run = ".trun"; $can = ".tcan"; global $tmpdir; rf_touch($tmpdir.$fn.$can); return true; } function rfriends_exec_check_can($fn) { $run = ".trun"; $can = ".tcan"; global $tmpdir; if (file_exists($tmpdir.$fn.$can)) return true; return false; } function rfriends_exec_check_run($fn) { $run = ".trun"; $can = ".tcan"; global $tmpdir; if (file_exists($tmpdir.$fn.$run)) return true; return false; } function rfriends_exec_sub($dt, $exno, $opt, $nam) { global $tmpdir; global $logdir; global $scrdir; $ex = ""; switch ($exno) { case 1: $pgm = "rfriends_exec_cleanlog"; break; case 2: $pgm = "rfriends_exec_radiko"; break; case 3: $pgm = "rfriends_exec_radiru"; break; case 4: $pgm = "rfriends_exec_timefree_kw"; break; case 5: $pgm = "rfriends_exec_timefree"; break; case 9: case 10: $pgm = "rfriends_exec_wdat_rec"; $optx = explode(",", $opt); if (count_73($optx) >= 6) { $nam = $optx[5]; } break; case 11: $pgm = "rfriends_exec_delivery"; $nam = "delivery"; break; case 12: $pgm = "rfriends_exec_podcast"; if ($nam == "") { $nam = "rfriends_exec_podcast"; } break; case 13: $pgm = "rfriends_exec_play"; $nam = "play"; break; case 14: $pgm = "rfriends_exec_live"; $nam = "live"; break; case 15: $pgm = "rfriends_exec_backup"; $nam = "backup"; break; case 16: $pgm = "rfriends_exec_duplicate"; $nam = "duplicate"; break; case 17: $pgm = "rfriends_exec_timefree_multi"; break; case 18: $pgm = "rfriends_exec_wdat_rec_multi"; break; default: $pgm = "rfriends_exec_dummy"; return; break; } if ($nam == "") { $nam = $pgm; } $fn = make_fn_daily($nam.$ex); $log1 = $tmpdir.$fn.".out"; $log2 = $logdir.$fn.".log"; external_php_program("$scrdir$pgm.php $opt > $log1 2>&1"); $pgm = "rfriends_exec_fin"; external_php_program("$scrdir$pgm.php $exno \"$log1\" \"$log2\""); return; } function rfriends_exec_daily($dt, $exno, $opt, $exnam) { global $sch_rsv_radiko; global $sch_rsv_radiru; global $sch_rsv_timefree; global $sch_rsv_radiru_vod; global $sch_rsv_radiru_gogaku; global $sch_rsv_podcast; global $tmpdir; global $cleanlog_fn; global $ex_radiru_vod; global $ex_radiru_gogaku; global $rfriends_ver; $tsch_rsv_radiko = $sch_rsv_radiko; $tsch_rsv_radiru = $sch_rsv_radiru; $tsch_rsv_timefree = $sch_rsv_timefree; $tsch_rsv_radiru_vod = $sch_rsv_radiru_vod; $tsch_rsv_radiru_gogaku = $sch_rsv_radiru_gogaku; $tsch_rsv_podcast = $sch_rsv_podcast ; $tsch_rsv_clean = "on"; $mode = ""; if ($opt != "") $mode = "(manual)"; $op = ""; rf_error_log($rfriends_ver); rf_error_log("Daily Program".$mode." start 1.11 $opt"); if ($opt != "") { $tsch_rsv_radiko = "off"; $tsch_rsv_radiru = "off"; $tsch_rsv_timefree = "off"; $tsch_rsv_radiru_vod = "off"; $tsch_rsv_radiru_gogaku = "off"; $tsch_rsv_podcast = "off"; $tsch_rsv_clean = "off"; $exp = explode(",",$opt); if (count_73($exp) == 7) { if ($exp[0] == 1) $tsch_rsv_radiko = "on"; if ($exp[1] == 1) $tsch_rsv_radiru = "on"; if ($exp[2] == 1) $tsch_rsv_timefree = "on"; if ($exp[3] == 1) $tsch_rsv_radiru_vod = "on"; if ($exp[4] == 1) $tsch_rsv_radiru_gogaku = "on"; if ($exp[5] == 1) $tsch_rsv_podcast = "on"; if ($exp[6] == 1) $tsch_rsv_clean = "on"; } else { rf_error_log("Daily Program".$mode." error "); } } if ($tsch_rsv_radiko == "on") { rf_error_log("daily_radiko"); rfriends_exec_sub($dt, 2, $op, "daily_radiko".$exnam); } if ($tsch_rsv_radiru == "on") { rf_error_log("daily_radiru"); rfriends_exec_sub($dt, 3, $op, "daily_radiru".$exnam); } if ($tsch_rsv_timefree == "on") { rf_error_log("daily_timefree"); rfriends_exec_sub($dt, 5, $op, "daily_timefree".$exnam); } if ($tsch_rsv_radiru_vod == "on") { rf_error_log("daily_radiru_vod"); $opt2 = "$ex_radiru_vod,2,-1,3,"; rfriends_exec_sub($dt, 9, $opt2, "daily_radiru_vod".$exnam); } if ($tsch_rsv_radiru_gogaku == "on") { rf_error_log("daily_radiru_gogaku"); gogaku_wait(); $opt2 = "$ex_radiru_gogaku,2,-1,3,"; rfriends_exec_sub($dt, 10, $opt2, "daily_radiru_gogaku".$exnam); } if ($tsch_rsv_podcast == "on") { rf_error_log("daily_podcast"); rfriends_exec_sub($dt, 12, "", "daily_podcast".$exnam); } if ($tsch_rsv_clean == "on") { rf_error_log("daily_clean"); $fn = $tmpdir.$cleanlog_fn; rf_touch($fn); rfriends_exec_sub($dt, 1, $op, "daily_clean".$exnam); } rf_error_log("Daily Program".$mode." end"); } function rfriends_exec_daily2($dt, $exno, $opt, $exnam) { global $sch_rsv_radiko; global $sch_rsv_radiru; global $sch_rsv_timefree; global $sch_rsv_radiru_vod; global $sch_rsv_radiru_gogaku; global $sch_rsv_podcast; global $tmpdir; global $cleanlog_fn; global $ex_radiru_vod; global $ex_radiru_gogaku; global $rfriends_ver; $op = $opt; $sch_rsv_clean = "on"; rf_error_log($rfriends_ver); rf_error_log("Daily Program2  start 1.11 $opt"); if ($sch_rsv_radiko == "on") { rf_error_log("daily_radiko"); rfriends_exec_sub($dt, 2, $op, "daily_radiko".$exnam); } if ($sch_rsv_radiru == "on") { rf_error_log("daily_radiru"); rfriends_exec_sub($dt, 3, $op, "daily_radiru".$exnam); } if ($sch_rsv_timefree == "on") { rf_error_log("daily_timefree"); rfriends_exec_sub($dt, 5, $op, "daily_timefree".$exnam); } if ($sch_rsv_radiru_vod == "on") { rf_error_log("daily_radiru_vod"); $opt2 = "$ex_radiru_vod,2,-1,3,"; rfriends_exec_sub($dt, 9, $opt2, "daily_radiru_vod".$exnam); } if ($sch_rsv_radiru_gogaku == "on") { rf_error_log("daily_radiru_gogaku"); gogaku_wait(); $opt2 = "$ex_radiru_gogaku,2,-1,3,"; rfriends_exec_sub($dt, 10, $opt2, "daily_radiru_gogaku".$exnam); } if ($sch_rsv_podcast == "on") { rf_error_log("daily_podcast"); rfriends_exec_sub($dt, 12, "", "daily_podcast".$exnam); } if ($sch_rsv_clean == "on") { rf_error_log("daily_clean"); $fn = $tmpdir.$cleanlog_fn; rf_touch($fn); rfriends_exec_sub($dt, 1, $op, "daily_clean".$exnam); } rf_error_log("Daily Program2 end"); } require_once("rf_inc.php"); $rfriends_mes = "ラジオ録音ツール"; $dt = date("Ymd"); switch ($argc) { case 1: $exno = 0; $opt = ""; $exnam = ""; break; case 2: $exno = $argv[1]; $opt = ""; $exnam = ""; break; case 3: $exno = $argv[1]; $opt = $argv[2]; $exnam = ""; break; case 4: $exno = $argv[1]; $opt = $argv[2]; $exnam = $argv[3]; break; default: echo_prn(2, "parameter error"); exit; break; } switch ($exno) { case 0: rfriends_exec_daily($dt, $exno, $opt, $exnam); break; case -1: rfriends_exec_daily2($dt, $exno, $opt, $exnam); break; default: rfriends_exec_sub($dt, $exno, $opt, $exnam); break; } exit; ?>
