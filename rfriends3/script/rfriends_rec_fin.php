<?php
 function fin_unlink_dbg($src) { global $debug_fin; if ($debug_fin == 1) { rf_move($src, $src.".dbg"); } else { fin_unlink($src); } } function fin_rename_dbg($src, $dst) { global $debug_fin; if ($debug_fin == 1) { rf_copy($src, $src.".dbg"); rf_move($src, $dst); } else { fin_rename($src,$dst); } } function fin_exec($ex_type, $fnm) { global $tmpdir; global $logdir; global $rsvdir; global $del_log; global $fin_sleep; global $user_process; global $user_process2; global $cfgdir; global $loghead_error; global $loghead_skip; global $dwn_extension; $skp1 = $tmpdir."$fnm.skp"; $flg1 = $tmpdir."$fnm.flg"; $end1 = $tmpdir."$fnm.end"; $log1 = $tmpdir."$fnm.out"; $log2 = $logdir."$fnm.log"; $logu = $logdir."$fnm"."_user.log"; $err1 = $tmpdir."$fnm.err"; $err2 = $logdir."$fnm.err"; $aac1 = $tmpdir."$fnm.$dwn_extension"; $aac2 = $logdir."$fnm.$dwn_extension"; $tim1 = $tmpdir."$fnm.tim"; $tim2 = $logdir."$fnm.tim"; $slp1 = $tmpdir."$fnm.slp"; $slp2 = $logdir."$fnm.slp"; $fin1 = $tmpdir."$fnm.fin"; $fin2 = $logdir."$fnm.fin"; $can1 = $tmpdir."$fnm.can"; $can2 = $logdir."$fnm.can"; $bat1 = $rsvdir."$fnm.bat"; $bat2 = $logdir."$fnm.bat"; $sh1 = $rsvdir."$fnm.sh"; $sh2 = $logdir."$fnm.sh"; $dat1 = $rsvdir."$fnm.dat"; $dat2 = $logdir."$fnm.dat"; $dat3 = $tmpdir."$fnm.dat"; $ttl = $tmpdir."$fnm.ttl"; sleep($fin_sleep); fin_unlink_dbg($bat1); fin_unlink_dbg($sh1); fin_unlink_dbg($dat1); fin_unlink_dbg($dat3); if (file_exists($ttl)) { $fnm2 = file_get_contents($ttl); fin_unlink($ttl); } else { $fnm2 = $fnm; } $finerr = 0; if (file_exists($log1)) { $tail = trim(rf_tail($log1)); if (substr($tail,0,7) == 'Start :') $tail = '[rfriends end]'; } else { $tail = ""; } if (file_exists($flg1)) $finerr = 1; if ($tail != '[rfriends end]') $finerr = 1; if ($finerr == 0) { if (file_exists($skp1)) { $log2 = $logdir."$loghead_skip"."$fnm.log"; fin_unlink_dbg($skp1); } if ($del_log == 0) { fin_unlink_dbg($slp1); } else { fin_unlink_dbg($err1); fin_unlink_dbg($slp1); } } else { $log2 = $logdir.$loghead_error."$fnm.log"; $err2 = $logdir.$loghead_error."$fnm.err"; $tim2 = $logdir.$loghead_error."$fnm.tim"; $aac2 = $logdir.$loghead_error."$fnm.$dwn_extension"; } fin_rename_dbg($log1, $log2); fin_rename_dbg($err1, $err2); fin_rename_dbg($aac1, $aac2); fin_rename_dbg($slp1, $slp2); fin_unlink_dbg($skp1); fin_unlink_dbg($can1); rfgw_fin($ex_type, $fnm); if ($finerr == 0) { $cnd = 0; } else { $cnd = -1; } fin_mail( $cnd, 0, $ex_type, $fnm2, $log2, $err2,$tim2); fin_notify($cnd, 0, $ex_type, $fnm2, $log2, $err2); if ($user_process == 1) { $up_mes1 = date("Y/m/d H:i:s")." rfriends_rec_fin user process start-up"; echo_prn(1, $up_mes1); $ex = "user_process"; rfgw_batsh_sub($cfgdir, $ex, $log2, 1, 1); $up_mes2 = date("Y/m/d H:i:s")." rfriends_rec_fin user process start-up complete"; echo_prn(1, $up_mes2); } fin_unlink_dbg($flg1); } require_once("rf_inc.php"); $rfriends_mes = "ラジオ録音ツール"; echo_prn(1, "rfriends_rec_fin start"); if ($argc != 2) { echo_prn(1, "radiko_rec parametaer error"); exit(1); } $p = explode(",", $argv[1]); if (count_73($p) == 4) { $test_mode = $p[0]; $msg_level = $p[1]; $ex_type = $p[2]; $fnm = $p[3]; } else { echo_prn(1, "radiko_rec parametaer error"); exit(1); } if ($dont_sleep == 1) { fin_wait_fn($tmpdir."$fnm.tim"); } fin_exec($ex_type, $fnm); echo_prn(1, "rfriends_rec_fin end"); exit(0); 