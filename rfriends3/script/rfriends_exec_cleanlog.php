<?php
 require_once("rf_inc.php"); require_once("rf_reserve.php"); require_once("rf_menu2.php"); $rfriend_mes = "ラジオ録音ツール"; $test_mode = 0; $msg_level = 1; $log_n = $log_lifetime; $rsv_n = 8; $tmp_n = 1; $tmp_n2 = 10; $storage = 1; $bup = $rfbackup; $bupm = $rfbackup_mode; $bupdir = $rfbackup_dir; $rfmov = $rfmove_dup; if ($argc == 2) { $p = explode(",", trim($argv[1])); if (count_73($p) == 5) { $test_mode = $p[0]; $msg_level = $p[1]; $log_n = $p[2]; $rsv_n = $p[3]; $tmp_n = $p[4]; $storage = 1; $bup = 0; $rfmov = 0; } } rf_system_info($ex_clean); $st_tm = start_prn(1, "RfriendsDaily ClearLog Start 1.13"); echo_prn(1, ""); stat_prn(1, "vmstat"); echo_prn(1, ""); echo_prn(1, "log : $log_n"); echo_prn(1, "rsv : $rsv_n"); echo_prn(1, "tmp : $tmp_n"); echo_prn(1, "stg : $storage"); echo_prn(1, "dup : $rfmov"); $pat = "{*.log,*.dbg,*.aac,*.err,*.flg,*.out,*.slp,*.tim,*.xml,*.json}"; echo_prn(1, str_repeat("+",40)); if ($log_n > 0) { echo_prn(1, "logdir : $log_n $logdir [$pat]"); $ret = clear_log($log_n, $logdir, $pat, 1, 1, 0); echo_prn(1, "clear count : $ret"); } else { echo_prn(1, "logdir : stop"); } $pat = "{*.bat,*.sh,*.dat}"; echo_prn(1, str_repeat("+",40)); if ($rsv_n > 0) { echo_prn(1, "rsvdir : $rsvdir [$pat]"); $ret = clear_log_hour($rsv_n, $rsvdir, $pat, 1, 1, 1); echo_prn(1, "clear count : $ret"); } else { echo_prn(1, "rsvdir : stop"); } echo_prn(1, str_repeat("+",40)); echo_prn(1, "broken link rsvdir : $rsvdir (linux)"); $ret = rfgw_rm_atque(1); if ($ret >= 0) { echo_prn(1, "broken link clear count : $ret"); } else { echo_prn(1, "broken link rsvdir : stop"); } $pat = "{*.aac,*.m4a,*.mp3}"; echo_prn(1, str_repeat("+",40)); echo_prn(1, "tmpdir data : 4 hours  $tmpdir [$pat]"); $ret = clear_log_hour(4, $tmpdir, $pat, 1, 1, 0); echo_prn(1, "clear count : $ret"); $pat = "{*.err,*.flg,*.out,*.slp,*.tim,*.dat,*.can,*.end,*.skp,*.run,*.jpg,*.jpeg,*.png,*.ttl}"; echo_prn(1, str_repeat("+",40)); if ($tmp_n2 > 0) { echo_prn(1, "tmpdir : $tmp_n2 hours $tmpdir [$pat]"); $ret = clear_log_hour($tmp_n2, $tmpdir, $pat, 1, 1, 0); echo_prn(1, "clear count : $ret"); } else { echo_prn(1, "tmpdir : stop"); } echo_prn(1, str_repeat("+",40)); rfgw_cleanupsch(); $exp = 3600 * 24 * 9; $pat = $schdir."*_*.xml"; echo_prn(1, "delete old schedule data(Radiko) [$pat]"); rf_sch_expire_radiko(1, $st_tm, $exp, $pat, 1); $pat = $schdir."*_*_*.json"; echo_prn(1, "delete old schedule data(Radiru) [$pat]"); rf_sch_expire_radiru(1, $st_tm, $exp, $pat, 1); if ($rfmov == 1 || $rfmov == 2) { echo_prn(1, ""); echo_prn(1, str_repeat("-", 60)); $en_tm = start_prn(1, "rfmove_dup start(full)"); echo_prn(1, ""); rf_info_double_s(1); $en_tm = start_prn(1, "rfmove_dup start(part)"); rf_info_double_s(2); if ($rfmov == 2) { $en_tm = start_prn(1, "rfmove_dup start(del)"); rfmenu_info_double_del_s(); } $en_tm = start_prn(1, "rfmove_dup end"); } if ($bup != 0) { echo_prn(1, ""); echo_prn(1, str_repeat("-", 60)); echo_prn(1, "rfbackup start"); echo_prn(1, ""); echo_prn(1, "bup  : $bup 日以上前"); echo_prn(1, "mode : $bupm"); echo_prn(1, "dir  : $usrdir -> $bupdir"); echo_prn(1, ""); $bupstatus = rf_bupdir_chk($bup,$bupm,$bupdir); if ($bupstatus === true) { $lists = rfbacup_file($bup,$usrdir); rfbacup_file_ex($bupm,$usrdir,$bupdir,$lists); } echo_prn(1, ""); echo_prn(1, "rfbackup end"); } echo_prn(1, str_repeat("-", 60)); echo_prn(1, "現在の使用量 usrdir : $usrdir"); echo_prn(1, ""); rfmenu_info_use_s($usrdir,1); echo_prn(1, str_repeat("-", 60)); if ($storage == 1) { $ret = rf_storage_control_exec("usr"); if ($ret === true) { echo_prn(1, ""); echo_prn(1, "現在の使用量 usrdir : $usrdir"); echo_prn(1, str_repeat("-", 60)); rfmenu_info_use_s($usrdir,1); } } if ($rftrans == 2) { echo_prn(1, ""); echo_prn(1, str_repeat("-", 60)); echo_prn(1, "現在の使用量 transdir : $rftrans_dir"); echo_prn(1, str_repeat("-", 60)); rfmenu_info_use_s($rftrans_dir,1); $ret = rf_storage_control_exec("trans"); if ($ret === true) { echo_prn(1, str_repeat("-", 60)); echo_prn(2, "現在の使用量 transdir : $rftrans_dir"); echo_prn(2, str_repeat("-", 60)); rfmenu_info_use_s($rftrans_dir,1); } } echo_prn(1, str_repeat("-",60)); $log = ini_get("error_log"); $log2 = $log.".1"; if (file_exists($log)) { $log_s = filesize($log); $log_s_max = 100*1024; if ($svcmode["service_mode"] == 1) { if ($svcmode["service_log_errors"] == 1) $log_s_max = 1*1024*1024; } if ($log_s > $log_s_max) { rename($log,$log2); echo_prn(1, "rename $log $log2"); } } if (file_exists($log)) { $log_s = filesize($log); $ts = @filemtime($log); if ($ts !== false) { $tm = date("Y/m/d H:i:s",$ts); } else { $tm = "unknown"; } echo_prn(1, "error_log : $log    size : $log_s byte(s)   last_errors : $tm"); } else { echo_prn(1, "error_log : $log  no errors"); } if (file_exists($log2)) { $log_s = filesize($log2); echo_prn(1, "error_log : $log2  size : $log_s byte(s)"); } $en_tm = start_prn(1, "RfriendsDaily ClearLog End"); rf_statistics($st_tm, $en_tm); exit; 