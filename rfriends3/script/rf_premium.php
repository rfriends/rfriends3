<?php
 function premium_init() { if (rf_product_check() != "P") { return false; } $parea = premium_getarea(); $no = rf_convjp($parea); if ($no != 0) { return false; } return $parea; } function premium_getpref() { global $premium_area; global $pref_code; $no = rf_convjp($premium_area); if ($no != 0) { $parea = $pref_code[$no]; } else { $parea = ""; } return $parea; } function premium_setarea($no) { global $premium_area; global $area_code; global $nowarea; $premium_area = sprintf("JP%d", $no); $area_code = $premium_area; $pref = premium_getpref(); $nowarea = "$area_code,$pref"; } function premium_putarea_fl($fl, $area) { $parea = strtoupper($area); $no = rf_convjp($parea); if ($fl != "") { file_put_contents($fl, $parea, LOCK_EX); premium_setarea($no); } return true; } function premium_getarea_fl($fil) { global $home_area_code; if (!file_exists($fil)) { $parea = $home_area_code; premium_putarea_fl($fil, $parea); } $area = file_get_contents($fil); $parea = strtoupper($area); $no = rf_convjp($parea); if ($no == 0) { fin_unlink($fil); $no = 1; $parea = "JP1"; } premium_setarea($no); return $parea; } function premium_putarea($area) { global $premiumareafile; $ret = premium_putarea_fl($premiumareafile, $area); return $ret; } function premium_getarea() { global $premiumareafile; $ret = premium_getarea_fl($premiumareafile); return $ret; } function premium_mail($no,$m) { global $premium; global $premium_mail; global $premium_area; global $home_area_code; global $send_mail_mode; global $send_mail_line_mode; $dt = date("Y/m/d H:i:s"); $mes = "radiko premium ログイン状況 \r\n\r\n"; switch($no) { case 1: $subj = "Enabled premium login"; $mes = $mes . "ラジコプレミアムへのログインは有効です。\r\n"; break; case 2: $subj = "Disabled premium login"; $mes = $mes . "ラジコプレミアムへのログインは無効です。\r\n"; break; case 3: $subj = "Expired premium login"; $mes = $mes . "ラジコプレミアムは期限切れです。\r\n"; break; case 4: $subj = "Succeeded premium login"; $mes = $mes . "ラジコプレミアムへの再ログインに成功しました。\r\n"; break; case 5: $subj = "Failed premium login"; $mes = $mes . "ラジコプレミアムへの再ログインに失敗しました。\r\n"; break; case 6: $subj = "Need premium relogin"; $mes = $mes . "ラジコプレミアムへログインしてから $m 日経過しています。\r\n"; break; default: $subj = "????? premium login ($no)"; $mes = $mes . "NO ミス\r\n"; break; } $mes = $mes . "\r\n"; $mes = $mes . "date           : $dt \r\n"; $mes = $mes . "id             : $premium_mail \r\n"; $mes = $mes . "premium        : $premium \r\n"; $mes = $mes . "premium area   : $premium_area \r\n"; $mes = $mes . "home area code : $home_area_code \r\n"; if ($send_mail_mode > 0 ) { free_mail($subj,$mes); } if ($send_mail_line_mode > 0 ) { $mes= $subj."\r\n".$mes; rfgw_line_notify(0,$mes); } } function premium_check_timeout() { global $premium; global $premium_mail; global $premium_area; global $cookiefile; global $premiumareafile; global $home_area_code; global $premium_autologin; global $premium_lifetime; $p_area = $premium_area; $ret = premium_logincheck(); if ($ret === true) { echo_prn(1,"radiko_premium_login OK"); if ($premium_area == "") { premium_getarea(); } } else { if($premium_autologin != "y") { echo_prn(1, "ラジコプレミアムのオートログインが有効ではありません。"); echo_prn(1, "ラジコプレミアムにログインしていません。"); return false; } premium_login(); if (premium_logincheck() === false) { echo_prn(1, "failed radiko_premium_login : $premium_mail"); premium_mail(5,""); return false; } echo_prn(1, "succeeded radiko_premium_login : $premium_mail"); } premium_putarea($p_area); if ($premium_area == "") { premium_getarea(); } return true; } function premium_check() { global $premium; global $premium_area; global $premium_autologin; global $cookiefile; global $premiumareafile; global $home_area_code; if (rf_product_check() != "P") { return -1; } if ($premium != 1 && $premium != 2) { return 0; } return $premium; } function premium_login() { global $opt_login; global $login_url; global $loginfile; global $cookiefile; global $radikosessionfile; global $premium_mail; global $premium_password; global $premium_area; global $area_code; global $home_area_code; global $auth_token_dat; global $premium; $rfriends_mes = "ラジオ録音ツール"; $pw = $premium_password; if ($pw == "") { echo_msg(2,"premium_passwordが設定されていません。"); echo_msg(2,"premium_passwordを設定してください。"); return false; } $opt = $opt_login . " --post-data=\"mail=$premium_mail&pass=$pw\"" . " --save-cookie=" . $cookiefile; $url = $login_url; $r = rand(0, 9999); $rn = sprintf("%04d", $r); $fl = $loginfile."_".$rn; switch($premium) { case 1: $ret = rf_wget($url, $fl, $opt); if ($ret === false) { fin_unlink($fl); echo_msg(2,"premium_login failed : $premium_mail"); echo_msg(2,"use previous data to access radiko"); return false; } $json_data = json_decode(file_get_contents($fl),true); fin_unlink($fl); $paid_member = 0; $areafree = 0; $radiko_session = ""; if (array_key_exists("paid_member", $json_data)) { $paid_member = $json_data["paid_member"] + 0; } if (array_key_exists("areafree", $json_data)) { $areafree = $json_data["areafree"] + 0; } if (array_key_exists("radiko_session", $json_data)) { $radiko_session = $json_data["radiko_session"]; } if ($paid_member != 1 || $areafree != 1) { echo_msg(2,"premium_login failed : $premium_mail,$paid_member,$areafree,$radiko_session"); return false; } $ret = file_put_contents($radikosessionfile,$radiko_session, LOCK_EX); if ($ret === false) { echo_msg(2,"radiko_session put error : $radiko_session"); return false; } else { echo_msg(2,"radiko_session : $radiko_session"); $sessiondate = @filemtime($radikosessionfile); if ($sessiondate !== false) { echo_msg(2,"session date : ". date("Y/m/d H:i:s",$sessiondate)); } else { echo_msg(2,"session date : ". "?????"); } } break; case 2: $ret = 0; rf_touch("$cookiefile"); echo_msg(2, "test用に空の $cookiefile を作成しました。"); break; default: return false; break; } if (!file_exists($cookiefile)) { echo_msg(2,"premium_login failed : $cookiefile"); return false; } $pref = premium_getpref(); if ($pref == "") { $premium_area = $home_area_code; premium_putarea($premium_area); } fin_unlink($auth_token_dat); auth_ex(0); echo_msg(2,"premium login successful"); return true; } function premium_logout() { global $opt_logout; global $logout_url; global $logoutfile; global $cookiefile; global $radikosessionfile; global $premium; global $premium_area; global $home_area_code; switch($premium) { case 1: if (!file_exists($cookiefile)) return true; $r_radiko_session = file_get_contents($radikosessionfile); $opt = $opt_logout . " --post-data=\"radiko_session=$r_radiko_session\"" . " --load-cookies ".$cookiefile; $url = $logout_url; $fl = $logoutfile; rf_wget($url, $fl, $opt); fin_unlink($cookiefile); fin_unlink($radikosessionfile); fin_unlink($fl); auth_ex(0); break; case 2: $fl = $logoutfile; fin_unlink($cookiefile); fin_unlink($fl); break; default: fin_unlink($cookiefile); fin_unlink($radikosessionfile); return true; } $premium_area = $home_area_code; premium_putarea($premium_area); return true; } function premium_logincheck() { global $premium; global $premium_autologin; global $opt_logincheck; global $logincheck_url; global $logincheckfile; global $cookiefile; global $radikosessionfile; global $premium; global $premium_lifetime; if(!file_exists($cookiefile)) { return false; } if ($premium == 2) { return true; } if ($premium != 1) { return false; } if(!file_exists($radikosessionfile)) { echo_msg(2,"radiko session file not found"); fin_unlink($cookiefile); return false; } $sessiondate = filemtime($radikosessionfile); $session = (time() - $sessiondate) / (60*60) ; $session = ceil( $session * 10 )/10; $pl = $premium_lifetime; if ($pl < 0) $pl = 0; echo_msg(2,"session date : ". date("Y/m/d H:i:s",$sessiondate)." (now: $session H [lifetime: $pl H])"); if ($session > $pl) { echo_msg(2,"premium logincheck (expired)"); return false; } $at = rf_radiko_hls(0,1); if ($at === false) { echo_msg(2,"premium logincheck (expired?)"); fin_unlink($cookiefile); fin_unlink($radikosessionfile); return false; } echo_msg(2,"premium logincheck OK"); return true; } function premium_flu($tm) { $st_flu = $tm; if ($st_flu < 0) $st_flu = 0; if ($st_flu > 10) $st_flu = 10; $flu = 0; $flus = 0; if ($st_flu > 0) { $flu = rand(0,$st_flu); $flus = rand(0,999); } if ($flu > 0) { sleep($flu); } if ($flus > 0) { usleep($flus*1000); } $flu_sec = $flu + $flus/1000; return $flu_sec; } function rf_set_premium_home() { global $home_area_code; global $premium_home_area_code; $premium_home_area_code = $home_area_code; if (premium_check() > 0) { $sta = rf_get_keyword('premium_main_station'); if (count_73($sta) > 0) { $area = $sta[0]; $no = rf_convjp($area); if ($no > 0) { $premium_home_area_code = $area; } } } } function premium_initialize() { global $scrdir; global $defdir; global $cfgdir; global $tmpdir; global $premiumini; global $cookiefile; global $loginfile; global $logoutfile; global $logincheckfile; global $premiumareafile; global $radikosessionfile; global $premium; global $premium_mail; global $premium_password; global $premium_area; global $premium_areafree; global $premium_timefree30; global $premium_autologin; $cookiefile = $tmpdir."rfriends_cookiefile"; $loginfile = $tmpdir."rfriends_loginfile"; $logoutfile = $tmpdir."rfriends_logoutfile"; $logincheckfile = $tmpdir."rfriends_logincheckfile"; $premiumareafile = $tmpdir."rfriends_premiumarea"; $radikosessionfile = $tmpdir."rfriends_radikosessionfile"; $premium = 0; $premium_mail = ""; $premium_password = ""; $premium_area = ""; $premium_areafree = 0; $premium_timefree30 = 0; $premium_autologin = "y"; $fl0 = $scrdir.$premiumini; $fl1 = $defdir.$premiumini; $fl2 = $cfgdir.$premiumini; if (rf_product_check() == "P") { copy_defusr(0, $premiumini); } if (!file_exists($fl2)) { return; } $inipremium = @parse_ini_file($fl2); if ($inipremium === false) { echo "\n"; echo "プレミアム設定が間違っています。: $fl2 \n"; echo "設定を無視します。\n"; rf_error_sleep(); return; } if (array_key_exists("premium", $inipremium)) { $premium = $inipremium["premium"]; } if (array_key_exists("premium_mail", $inipremium)) { $premium_mail = $inipremium["premium_mail"]; } if (array_key_exists("premium_password", $inipremium)) { $premium_password = $inipremium["premium_password"]; } if (array_key_exists("premium_area", $inipremium)) { $premium_area = $inipremium["premium_area"]; } if (array_key_exists("premium_areafree", $inipremium)) { $premium_areafree = $inipremium["premium_areafree"]; } if (array_key_exists("premium_timefree30", $inipremium)) { $premium_timefree30 = $inipremium["premium_timefree30"]; } $premium_autologin = "y"; if ($premium_areafree == 0 && $premium_timefree30 == 0) { $premium_areafree = 1; } if ($premium < 0 || $premium > 2) { $premium = 0; } if ($premium_areafree != 1) { $premium_areafree = 0; } if ($premium_timefree30 != 1) { $premium_timefree30 = 0; } if ($premium == 0) { $premium_areafree = 0; $premium_timefree30 = 0; } if ($premium_areafree != 1) { fin_unlink($premiumareafile); } } 