<?php
 require_once("rf_inc.php"); require_once("rf_reserve.php"); $rfriends_mes = "ラジオ録音ツール"; $st_tm = start_prn(1, "Rfriends Delivery Start"); if ($argc != 2) { echo_prn(2, "rfriends_exec_delivery parameter error"); exit(8); } $opt = $argv[1]; switch($opt) { case 0: $exp = 0; $dt0 = "全期間"; break; case 1: $exp = 3600 * 24 * 1; $dt0 = "過去１日"; break; case 2: $exp = 3600 * 24 * 7; $dt0 = "過去１週間"; break; case 3: $exp = 3600 * 24 * 31; $dt0 = "過去１カ月"; break; default: echo_prn(2, "parameter error : $opt"); $en_tm = start_prn(1, "Rfriends Delivery End"); rf_statistics($st_tm, $en_tm); exit(0); break; } if ($exp > 0) { $tm = $st_tm - $exp; $dt1 = date("Y/m/d H:i:s",$tm); $dt2 = date("Y/m/d H:i:s",$st_tm); echo_prn(2,"期間 : $dt0 ($dt1 - $dt2)"); } else { echo_prn(2,"期間 : $dt0"); } $extype_names = array(); $extype_names[] = rf_get_extype_name($ex_radiko); $extype_names[] = rf_get_extype_name($ex_timefree); $extype_names[] = rf_get_extype_name($ex_radiru); $extype_names[] = rf_get_extype_name($ex_radiru_vod); $extype_names[] = rf_get_extype_name($ex_radiru_gogaku); $extype_names[] = rf_get_extype_name($ex_podcast); $users = rf_get_keyword("dlvy_users"); echo_prn(1, ""); echo_prn(1, "users :"); if (count_73($users) == 0) { $en_tm = start_prn(1, "Rfriends Delivery End"); rf_statistics($st_tm, $en_tm); exit(0); } else { foreach($users as $user) { echo_prn(1, " $user"); } } foreach($extype_names as $extype_name) { $extype = rf_get_extype($extype_name); if ($extype == $ex_podcast) { $exdir = $usrdir.$extype_name.$DS."user".$DS."*"; $pat = $exdir.$DS."*.*"; } else { $exdir = $usrdir.$extype_name; $pat = $exdir.$DS."*.".$rec_extension; } $files = glob($pat); if ($exp > 0) { foreach ($files as $key => $file) { if (($tm = filemtime($file)) === false){ unset($files[$key]); continue; } $df = $st_tm - $tm; if ($df > $exp) { unset($files[$key]); } } } asort($files); $files_count = count_73($files); echo_prn(1, ""); echo_prn(1, "[".$exdir."(".$files_count.")]"); foreach ($files as $file) { $recf = pathinfo($file,PATHINFO_FILENAME); $ext = pathinfo($file,PATHINFO_EXTENSION); $xml = array("title" => $recf); if (($tm = filemtime($file)) === false){ $tm = 0; } else { $tm = date("YmdHis",$tm); } foreach ($users as $user) { if (!file_exists($file)) { continue; } $delivery = "dlvy_".$user."_".$extype_name; $hit = delivery_rec_program_s($delivery, $xml, $recf, $ext, $file, 0, 0); } } } $en_tm = start_prn(1, "Rfriends Delivery End"); rf_statistics($st_tm, $en_tm); exit(0); 