<?php
 require_once('ht_inc.php'); $func = $_POST['func']; $para1 = $_POST['para1']; $para2 = $_POST['para2']; $para3 = $_POST['para3']; if ($svcmode["service_ajax"] == 1) { echo_msg(2,"non_ajax start"); echo_msg(2,"func : $func"); echo_msg(2,"para1 : $para1"); echo_msg(2,"para2 : $para2"); echo_msg(2,"para3 : $para3"); echo_msg(2,""); $ht_st = time(); } set_time_limit(600); error_reporting(0); switch($func) { case 'rec_kwsrc': $ret = ht_ajax_ex01($para1,$para2,$para3); break; case 'audee_detail': $ret = ht_ajax_ex02($para1,$para2,$para3); break; case 'audee_index': $ret = ht_ajax_ex03($para1,$para2); break; case 'audee_src': $ret = ht_ajax_ex04($para1,$para2); break; case 'audee_src_url': $ret = ht_ajax_ex04s($para1,$para2,$para3); break; case 'audee_keylist': $ret = ht_ajax_ex05($para1,$para2); break; case 'test02': $ret = ht_ajax_ex06($para1,$para2,$para3); break; case 'update': $ret = ht_ajax_ex07($para1,$para2,$para3); break; case 'audioplay': $ret = ht_ajax_ex08($para1,$para2,$para3); break; case 'pcast_rss_lfr': $ret = ht_ajax_ex09($para1,$para2,$para3); break; case 'radiko_program': $ret = ht_ajax_ex10($para1,$para2,$para3); break; case 'google_top': $ret = ht_ajax_ex11($para1,$para2,$para3); break; case 'audee_page': $ret = ht_ajax_ex12($para1,$para2,$para3); break; default : break; } if ($ret === false) { $ret = array(); } error_reporting(E_ALL); if ($svcmode["service_ajax"] == 1) { $ht_en = time(); $el = $ht_en - $ht_st; $cnt = count_73($ret); echo_msg(2,"non_ajax_mode count:$cnt elapse:$el sec"); ht_print_r($ret,"result"); } else { echo json_encode($ret); } exit; function console_log($data){ echo "<script>"; echo "console.log('.json_encode($data).')"; echo "</script>"; } function ht_ajax_ex01($ex_type,$kw,$val2) { $lists = array(); $rsvdata = rfmenu_rec_kwsrc_sub($ex_type,$kw,$val2); $cnt = count_73($rsvdata); if ($cnt > 0) { foreach($rsvdata as $wdata) { $para = get_para($wdata,$ex_type); $pcnt = count_73($para); if (is_null($para)) continue; if (count_73($para) < 7) continue; $dt1 = substr($para[0],0,4); $dt2 = substr($para[0],4,2); $dt3 = substr($para[0],6,2); $tm = substr($para[0],8,4); $ttl = $dt1."/".$dt2."/".$dt3."_".$tm." ".$para[7]; $lists[] = array('val' => "$wdata", 'title' => "$ttl"); } } $cnt = count_73($lists); $ids = array_column($lists, 'val'); array_multisort($ids, SORT_ASC, $lists); return $lists; } function ht_ajax_ex02($url,$st,$en) { $hlflg = 0; $lists = array(); $n = $en - $st + 1; $pg = $st; for ($no=1;$no<=$n;$no++) { $url2 = $url.'#page'.$pg; $pg++; $xmlObject = url2xml_ex($url2); if ($xmlObject === false) { $xmlObject = url2xml($url2); if ($xmlObject === false) return false; $hlflg = 1; } $q1 = '//section[@id = "content_tab_voice"]//div[@class="box-article-item"]/a'; $q2 = '//section[(@id = "content_tab_all"  ) and (contains(@class,"is-active"))]//div[@class="box-article-item"]/a'; $result = $xmlObject->xpath($q1); if ($result == null || $result === false) { return false; } $cnt = count_73($result); if ($cnt < 1) { return false; } foreach($result as $val) { if (empty($val->attributes()->href)) continue; $href = (string)$val->attributes()->href; if (strpos($href,'voice') === false) continue; $p = (string)$val->p; $p = utf8mac2utf8($p); $lists[] = array('title'=>$p,'val'=>$href); } if ($hlflg == 1) break; } return $lists; } function ht_ajax_ex03($url,$para2) { $xmlObject = url2xml($url); if ($xmlObject === false) { return false; } $result = $xmlObject->xpath( '//nav[contains(@class, "nav-tab")]//a'); $lists = array(); foreach($result as $val) { $idx = (string)$val[0]; $lists[] = array('title' => $idx,'val' => $idx); } return $lists; } function ht_ajax_ex04($home,$kw) { $lists = array(); $kw = trim($kw); if ($kw == "") { return false; } $keyword = urlencode($kw); $url = $home.'/search/v2?keyword='."'$keyword'"; $q = '//ul[contains(@class,"list-search-reult-01")]//li[@class="box-article-item"]//a[contains(@href,"/program/")]'; $q2 = urlencode($q); $lists = ht_ajax_ex04s($url,$q2,1); return $lists; } function ht_ajax_ex04s($url,$q,$mode) { $lists = array(); switch($mode) { case 1: $m0 = 1; $m1 = 0; break; case 2: $m0 = 0; $m1 = 1; break; case 3: $m0 = 1; $m1 = 1; break; case 0: default: $m0 = 0; $m1 = 0; break; } $q2 = urldecode($q); if ($mode == 1) { $xmlObject = url2xml_ex($url); } else { $xmlObject = url2xml($url); } if ($xmlObject === false) { return false; } $result = $xmlObject->xpath($q2); if ($result == null || $result === false) { return false; } $cnt = count_73($result); if ($cnt < 1) { return false; } foreach($result as $val) { if (empty($val->attributes()->href)) continue; $href = (string)$val->attributes()->href; $p = (string)$val->p; $p = utf8mac2utf8($p); $lists[] = array('title'=>$p,'val'=>$href); } return $lists; } function ht_ajax_ex05($url,$key) { $q = "//a[@data-key='$key']"; $lists = ht_audee_xml($url,$q); return $lists; } function ht_ajax_ex06($para1,$para2,$para3) { sleep(5); $lists = array(); $lists[] = array('title' => "結果表示startです。",'val' => "val"); $lists[] = array('title' => $para1,'val' => $para1); $lists[] = array('title' => $para2,'val' => $para2); $lists[] = array('title' => $para3,'val' => $para3); $lists[] = array('title' => "結果表示endです。",'val' => "val"); return $lists; } function ht_ajax_ex07($rst,$val,$para3) { $mes = ht_update_sub($val); $lists = array(); foreach($mes as $m) { $lists[] = array('title' => "$m",'val' => "$m"); } return $lists; } function ht_ajax_ex08($fnenc,$fnximg,$fnx) { global $htmldir; $lists = array(); $fn = rawurldecode($fnenc); $temp_fnimg = $htmldir.$fnximg; fin_unlink($temp_fnimg); $ret = external_program_null("ffmpeg -i $fn $temp_fnimg");; if ($ret != 0) { copy($htmldir."images/tempsound.jpg",$temp_fnimg); } $temp_fn = $htmldir.$fnx; $ret = copy($fn,$temp_fn); if ($ret === false) { $lists[] = array('title' => "失敗",'val' => ""); } else { $lists[] = array('title' => "成功",'val' => "$fnx"); } return $lists; } function ht_ajax_ex09($url,$home,$para3) { $page = $home."/brands/".$url."/"; $program_pages[] = $page; $xmlObject = url2xml($page); $result = $xmlObject->xpath( '//a[@class="page-numbers"]'); foreach($result as $val) { $program_pages[] = (string)$val->attributes()->href; } $lists = array(); foreach($program_pages as $url) { $xmlObject = url2xml($url); $result = $xmlObject->xpath( '//div[@class="ct_all_area"]//a' ); foreach($result as $val) { if (empty($val->div)) continue; if (empty($val->div[0]->attributes()->class)) continue; $class = (string)$val->div[0]->attributes()->class; if ($class != "img_ct_all") continue; $href = $home.(string)$val->attributes()->href."/"; $ttl = trim($val->div[1]); $html = @file_get_contents($href); if ($html === false) continue; $p2 = strpos($html,'/podcast.rss'); if ($p2 === false) continue; $p2 = $p2 + 12; $p1 = $p2 - 500; if ($p1 >= 0) { $html2 = substr($html,$p1,500); } else { $html2 = substr($html,0,$p2); } $p2 = strrpos($html2,'http'); if ($p2 === false) continue; $rss = substr($html2,$p2); $lists[] = array('title' => "$ttl", 'val' => "$rss"); } } return $lists; } function ht_ajax_ex10($ch, $dt, $cnt) { $rsvdata = rfmenu_radiko_program($ch, $dt, $cnt); $lists = array(); foreach($rsvdata as $key => $val) { $t = explode('_',$key); $dt = date('m/d H:i',strtotime($t[2])); $ttl = $dt.' '.$t[1]; $lists[] = array('title' => "$ttl", 'val' => "$val"); } ksort($lists); return $lists; } function ht_ajax_ex11($url, $para2, $para3) { $html = file_get_contents($url); $ptn = '/AF_initDataCallback\(.*?\);/'; if (!preg_match($ptn, $html, $matches)) { return false; } $json = $matches[0]; $p = strpos($json,', sideChannel:'); if ($p === false) { return false; } $json = substr($json,0,$p); $p = strpos($json,'data:'); if ($p === false) { return false; } $json = substr($json,$p+5); $json = '[{"data":'.$json.'}]'; $val = json_decode($json,true); if ($val === false) { return false; } $val2 = $val[0]['data'][0]; $c =0; $lists = array(); foreach($val2 as $v2) { if ($c == 0) { $c++; continue; } else { $t = $v2[0]; $v = ''; $val3 = $v2[1]; } $lists[] = array('title' => $t, 'val' => $v); foreach($val3 as $v3) { if ($c == 0) { $t = $v3[1]; $v = $v3[4][1]; } else { $t = $v3[3][0]; $v = $v3[3][6]; } $lists[] = array('title' => $t, 'val' => $v); } $c++; } if (count_73($lists) <= 0) { return false; } return $lists; } function ht_ajax_ex12($url, $pgm, $para3) { global $headless_browser; $lists = array(); $nmax = rf_podcast_audee_page($url); for ($i= 1;$i<=$nmax;$i++) { $mes = sprintf("page %02d",$i); $lists[] = array('title'=>$pgm." ($mes)",'val'=>"$url,$i,$i"); } return $lists; } ?>
