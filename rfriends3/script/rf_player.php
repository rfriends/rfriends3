<?php
 function rfriends_player($ex_type, $area, $chnnel) { global $streamurlhls; global $tmpdir; global $stream_url; global $msg_level; global $ffmpeg_loglevel; global $ffmpeg_loglevel_timefree; global $dont_sleep; global $dontsleep_timer_tf; global $rec_sleep_program; global $area_code; global $nowarea; global $home_area_code; global $usrdir; global $tmpdir; global $premium_area; global $ex_radiko; global $ex_radiru; global $ex_timefree; global $ex_radiru_vod; switch ($ex_type) { case $ex_radiko: $mode = rf_premium_mode($area,$channel); $authtoken = rfriends_auth_radiko($mode,$area,0); if (is_null($authtoken)) { echo_msg(2, "radiko_auth error ($mode)"); return; } $hlsurl = get_radiko_stream_url($channel, $recfiletmp, $mode); if ($hlsurl == "") { echo_prn(1, "stream_url not found (not delivered)"); return; } $opt = sprintf($ffopt, $hlsurl, $tout, $reg_dur, $authtoken); $expgm = "ffplay -loglevel $ffmpeg_loglevel"; break; case $ex_timefree: $nw = time(); $ret = timefree_check($nw, $para, 1); if ($ret != 0) { return; } $mode = rf_premium_mode($area,$channel); $authtoken = rfriends_auth_radiko($mode,$area,0); if (is_null($authtoken)) { echo_msg(2, "radiko_auth error ($mode)"); return; } $hlsurl = get_timefree_stream_url($channel, $fromtime, $totime, $recfiletmp, $authtoken,0); if ($hlsurl == "") { echo_prn(1, "stream_url not found (not delivered or area unmatch)"); return $rec_not_deliver; } echo_prn(1, $hlsurl); $tout = calc_timefree_timeout($reg_dur); $ffopt = rfgw_ffmpeg_opt($ex_timefree); $opt = sprintf($ffopt, $hlsurl, $tout, $reg_dur, $authtoken); $expgm = "ffplay -loglevel $ffmpeg_loglevel_timefree"; break; case $ex_radiru: $ok = ""; $hlsurl = radiru_hls_url($channel); if ($hlsurl == null) { echo_msg(2, "error $channel"); return $rec_abnormal_end; } $expgm = "ffplay -loglevel $ffmpeg_loglevel"; $tout = $reg_dur + 120; $ffopt = rfgw_ffmpeg_opt($ex_radiru); $opt = sprintf($ffopt, $hlsurl, $tout, $reg_dur); break; } $expgm = "ffplay -loglevel quiet"; $exec_cmd = "$expgm $opt $recfiletmp.$dwn"; echo_prn(1, ""); echo_prn(1, $exec_cmd); rf_touch("$recfiletmp.run"); $ret = external_program($exec_cmd); rf_touch("$recfiletmp.end"); fin_unlink("$recfiletmp.run"); return; } 