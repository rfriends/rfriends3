<?php
 function ext_radiko_auth_mode3($mode,$area_code) { global $nowarea; global $home_area_code; global $extdir; global $radiko_auth_mode3_dat; global $radiko_auth_mode; if ($area_code == "") { $home_area_code = get_mode3_pref($radiko_auth_mode3_dat); return true; } $dat = ext_radiko_auth_check($mode,$area_code,0); if ($dat !== false) { $dt = $dat[0]; $authtoken = $dat[1]; $area = $dat[2]; $diff = $dat[5]; echo_prn(1,"use prev. token"); return $authtoken; } switch($mode) { case 1: $dat = $area_code; $no = rf_convjp($dat); if ($no === false) { echo_prn(2,"area_code error $area_code"); return false; } if ($no == 0) { echo_prn(2,"area_code error $area_code"); return false; } $ret = rf_device_f_lat_lon($no); break; case 0: default: $ret = get_mode3_value($radiko_auth_mode3_dat); if ($ret === false) { echo_prn(2,"radiko_auth_mode3_dat error $radiko_auth_mode3_dat"); $radiko_auth_mode = 0; $authtoken = auth_ex(0); $radiko_auth_mode = 3; return $authtoken; } break; } $lat = $ret[0]; $lon = $ret[1]; $ans = ext_radiko_auth_gps($lat,$lon); if ($ans === false) { return false; } $ret = $ans[0]; if ($ret != 0) { return false; } if ($mode == 0) { $home_area_code = $ans[3]; set_area(); } $authtoken = $ans[4]; if ($authtoken !== false) { rf_put_auth($authtoken); $area = $ans[3]; $dt = date("YmdHis"); echo_prn(1,"new token    dt:$dt  auth:$authtoken  area:$area  $lat,$lon"); } return $authtoken; } function get_mode3_value($mode3_dat) { if (!file_exists($mode3_dat)) return false; $dat = trim(file_get_contents($mode3_dat)); if ($dat == "") return false; $v = explode(",",$dat); $n = count_73($v); switch($n) { case 1: $ret = ext_pref2gps($dat); if ($ret === false) return false; $lat = $ret[0]; $lon = $ret[1]; break; case 2: $lat = $v[0]; $lon = $v[1]; break; default: return false; break; } $ret = rf_get_pref($lat, $lon); if ($ret[0] == 0) { echo_prn(2,"lat_lon = $lat , $lon"); return false; } return [$lat,$lon]; } function get_mode3_pref($mode3_dat) { if (!file_exists($mode3_dat)) return false; $dat = trim(file_get_contents($mode3_dat)); if ($dat == "") return false; $v = explode(",",$dat); $n = count_73($v); switch($n) { case 1: $no = rf_convjp($dat); if ($no == 0) return false; break; case 2: $lat = $v[0]; $lon = $v[1]; $ret = rf_get_pref($lat, $lon); if ($ret[0] == 0) return false; $no = substr($ret[0],0,2) + 0; break; default: return false; break; } $pref = sprintf("JP%d", $no); return $pref; } function ext_radiko_auth_gps($lat,$lon) { global $fms1urlhls; global $fms2urlhls; $dat = rf_device_info(); $opt = ext_device_header1($dat); $ret1 = ext_get_auth1($opt); if ($ret1[0] != 0) { echo_prn(1, "auth1 error"); return false; } $atk = $ret1[1]; $ofs = $ret1[3]; $len = $ret1[4]; $pkey = rf_device_pkey($ofs, $len); if ($pkey === false) { echo_prn(1, "partialkey error : $ofs,$len"); return false; } $loc = "$lat,$lon,gps"; $opt = ext_device_header2($dat, $atk, $loc, $pkey); $ret2 = ext_get_auth2($opt); $ret = $ret2[0]; if ($ret != 0) { return false; } $nowarea = $ret2[1]; $area_code = $ret2[2]; $home_area_code = $area_code; return [$ret,$nowarea,$area_code,$home_area_code,$atk]; } function ext_pref2gps($pref) { $no = rf_convjp($pref); if ($no == 0) { echo_prn(2, "error pref ($pref)"); return false; } $gps = rf_device_f_lat_lon($no); return $gps; } function ext_get_auth1($opt) { global $fms1urlhls; $auth1 = rf_wget_out_exec($fms1urlhls, $opt); if ($auth1 === false) { echo_prn(1, "auth1 error"); return false; } $ret = get_auth1_value($auth1); if ($ret[0] != 0) { echo_prn(1, "auth1_value error"); return false; } return $ret; } function ext_get_auth2($opt) { global $fms2urlhls; $auth2 = rf_wget_out_exec($fms2urlhls, $opt); if ($auth2 === false) { echo_prn(1, "auth2 error"); return false; } $ret2 = get_auth2_value($auth2); return $ret2; } 