<?php
 require_once("rf_inc.php"); require_once("rf_reserve.php"); require_once("rf_radiko.php"); require_once("rf_radiko2.php"); require_once("rf_radiko3.php"); require_once("rf_menu_sub.php"); $rfriends_mes = "ラジオ録音ツール"; $test_mode = 0; $msg_level = 1; $dt0 = 0; $n_k = $radiko_reserve_daily; $n_r = $radiru_reserve_daily; if ($argc >= 2) { $p = explode(",", $argv[1]); if (count_73($p) == 5) { $test_mode = $p[0]; $msg_level = $p[1]; $dt0 = $p[2]; $n_k = $p[3]; $n_r = $p[4]; } } $ex_type = $ex_radiko; $nk = $n_k; if ($nk < 1) { $nk = 1; } if ($nk > 7) { $nk = 7; } $nk2 = $nk * 24; $rmax = $rsv_max; $nw = time(); $fr_nw = $nw + $s_mkoffs; $to_nw = $fr_nw + $nk*24*3600; $ret = rf_program_date($ex_type, $fr_nw, $to_nw); $dt = $ret[0]; $cnt = $ret[1]; if ($test_mode == 1) { echo_prn(1, "--------------------"); echo_prn(1, "番組予約リスト"); echo_prn(1, "--------------------"); } rf_system_info($ex_radiko); $st_tm = start_prn(1, "Radiko Start(1.21)"); echo_prn(1, ""); echo_prn(1, str_repeat("-", 60)); echo_prn(1, "番組表更新 start"); echo_prn(1, "");; $pgmcnt = 8; $pgmdt = time(); $pgmdt1 = strtotime("0 day", $pgmdt); $pgmdt2 = strtotime("7 day", $pgmdt); $pgmymd1 = date("Y/m/d",$pgmdt1); $pgmymd2 = date("Y/m/d",$pgmdt2); echo_prn(1, "radiko(home : $area_code) $pgmymd1 - $pgmymd2 ($pgmcnt days)"); echo_prn(1, ""); rf_program_radiko($pgmdt,$pgmcnt,$area_code); echo_prn(1, ""); echo_prn(1, "番組表更新 end"); echo_prn(1, str_repeat("-", 60)); $reserve = $base."script".$DS."rfriends_reserve.php"; start_prn(1, "RadikoReserve Start $cnt day(s)"); echo_prn(1, ""); $key = "radiko_ng_station"; $kw2 = rf_get_keyword($key); echo_prn(1, "Radiko_ng_station :"); echo_prn(1, ""); foreach ($kw2 as $val) { echo_prn(1, " $val"); } echo_prn(1, ""); $key = "radiko_ng_program"; $kw2 = rf_get_keyword($key); echo_prn(1, "Radiko_ng_program :"); echo_prn(1, ""); foreach ($kw2 as $val) { echo_prn(1, " $val"); } if (premium_check() > 0 && $premium_areafree == 1) { $area_code = $premium_home_area_code; $pref = rf_edit_area($area_code); $narea = "$area_code,$pref"; $secmes = "ラジコプレミアム  メインステーション : $narea"; rf_disp_section($secmes, "+"); } else { $pref = rf_edit_area($area_code); $narea = "$area_code,$pref"; $secmes = "ラジコ : $narea"; rf_disp_section($secmes, "+"); } $main_area = $area_code; echo_prn(2, ""); $kwdat_ng = merge_keyword($ex_radiko,1); $kwdat = merge_keyword($ex_radiko,0); echo_prn(2, ""); $rsvdata = radiko_rsv_ex($main_area, $kwdat,$kwdat_ng, $dt, $cnt, $nk2, 0, 0,$rmax); echo_prn(2, ""); echo_prn(2, "reserve data count(normal) : ".count_73($rsvdata)." (max : $rmax)"); $kw = "radiko_ng_program"; $lines = rf_get_keyword($kw); $nlines = count_73($lines); echo_prn(2, str_repeat("-", 40)); echo_prn(2, "$kw kw : $nlines"); $ncnt = 0; if ($nlines > 0) { foreach($lines as $line) { echo_prn(2, "kw : $line"); $rsvdata_new = array(); foreach($rsvdata as $wdat) { $para = get_para($wdat,$ex_type); if ($para[7] != $line) { $rsvdata_new[] = $wdat; } else { echo_prn(2, "remove ".$wdat); $ncnt++; } } $rsvdata = $rsvdata_new; } } echo_prn(2, ""); echo_prn(2, "radiko_ng_program remove count : $ncnt"); echo_prn(2, str_repeat("-", 40)); if ($radiko_ng_rec_auto == 1) { $rsvdata_ng = radiko_rsv_ex($main_area, $kwdat,$kwdat_ng, $dt, $cnt, $nk2, 1, 0,$rmax); $rsvdata = array_merge($rsvdata, $rsvdata_ng); echo_prn(2, ""); echo_prn(2, "reserve data count(ng)     : ".count_73($rsvdata_ng)); } rf_ex_reserve($test_mode, $ex_type, $rsvdata, $fr_nw, $to_nw); $kw = "radiko_timerec"; $lines = rf_get_keyword($kw); $nlines = count_73($lines); echo_prn(2, str_repeat("-", 40)); echo_prn(2, "$kw : $nlines"); if ($nlines > 0) { $station = rf_radiko_station($main_area); $rsvdata = rf_timerec($main_area, $test_mode, $ex_type, $nw, $lines, $station); rf_ex_reserve($test_mode, $ex_type, $rsvdata, $fr_nw, $to_nw); } if (premium_check() < 1 || $premium_areafree == 0) { $en_tm = start_prn(1, "RadikoReserve End"); rf_statistics($st_tm, $en_tm); exit; } $sta = rf_get_keyword('premium_station'); if (count_73($sta) == 0) { $mes = "premium_station が定義されていません。"; echo_prn(1, $mes); $en_tm = start_prn(1, "RadikoReserve End"); rf_statistics($st_tm, $en_tm); exit; } echo_prn(2, ""); foreach ($sta as $area) { $no = rf_convjp($area); if ($no == 0) { echo_prn(1, "premium_station 設定エラー ($area)"); continue; } $pref = rf_edit_area($area); $narea = "$area,$pref"; $secmes = "ラジコプレミアム  ステーション : $narea"; rf_disp_section($secmes, "+"); if ($area == $main_area) { echo_prn(1, "このエリアは main_station と重複しています。"); } $parea = "premium_".strtolower($area); $kwdat_ng = merge_keyword_area($area, $ex_radiko,1); $kwdat = merge_keyword_area($area, $ex_radiko,0); $kwcnt = count_73($kwdat); echo_prn(2, ""); $rsvdata = array(); if ($kwcnt > 0) { $rsvdata = radiko_rsv_ex($area, $kwdat,$kwdat_ng, $dt, $cnt, $nk2, 0, 0,$rmax); echo_prn(0, "reserve data count(normal) : ".count_73($rsvdata)); } if (count_73($rsvdata) > 0) { rf_ex_reserve($test_mode, $ex_type, $rsvdata, $fr_nw, $to_nw); } $kw = "premium_timerec_".strtolower($area); $lines = rf_get_keyword($kw); $nlines = count_73($lines); echo_prn(2, str_repeat("-", 40)); echo_prn(2, "$kw : $nlines"); if ($nlines > 0) { $station = rf_radiko_station($area); $rsvdata = rf_timerec($area, $test_mode, $ex_type, $nw, $lines, $station); rf_ex_reserve($test_mode, $ex_type, $rsvdata, $fr_nw, $to_nw); } } echo_prn(2, str_repeat("-", 40)); echo_prn(2, ""); start_prn(1, "RadikoReserve End"); $en_tm = start_prn(1, "Radiko End"); rf_statistics($st_tm, $en_tm); exit; 