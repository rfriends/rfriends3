<?php
function rfriends_auth_audio($ex_type,$area,$channel) { global $ex_radiko; global $ex_timefree; global $premium; global $radiko_auth_mode; if ($ex_type == $ex_radiko || $ex_type == 3 || $ex_type == $ex_timefree) { $mode = rf_premium_mode($area,$channel); echo_msg(2, "認証モード:$radiko_auth_mode  プレミアム:$mode  録音エリア:$area  CH:$channel"); $authtoken = rfriends_auth_radiko($mode,$area,0); if (is_null($authtoken)) { echo_msg(2, "authtoken が取得できませんでした。"); return false; } } return $authtoken; } function rfriends_live($ex_type,$para,$flg) { $ret = rfriends_live_sub($ex_type,$para,$flg,1); return $ret; } function rfriends_live_sub($ex_type,$para,$flg,$auto) { global $station_logo_url; global $ex_radiko; global $ex_radiru; global $ex_timefree; global $ex_radiru_vod; global $ex_radiru_gogaku; global $ex_podcast; global $nowarea; global $auth_token; global $ui_mode; global $scrdir; $piddata = rfmenu_play_abort_all(); $org = 0; switch($ex_type) { case $ex_radiko: $opt = rfriends_live_radiko($ex_type,$para,$flg); break; case $ex_timefree: $opt = rfriends_live_timefree($ex_type,$para,$flg,$org); break; case $ex_radiru: $opt = rfriends_live_radiru($ex_type,$para,$flg); break; case $ex_radiru_vod: case $ex_radiru_gogaku: $opt = rfriends_live_radiru_vod($ex_type,$para,$flg); break; case $ex_podcast: $opt = rfriends_live_podcast($ex_type,$para,$flg); break; default: return false; break; } if ($opt === false) return false; if ($auto == 1 && $ui_mode == 2) { if ($para[9] != ";") { msgx('<p><img src='.$para[9].' id="sndimg"></p>'); } else if($ex_type == $ex_radiru || $ex_type == $ex_radiru_vod) { $ch_cs = callsign2($para[6]); if ($ch_cs != "UNKNOWN") { $img = sprintf($station_logo_url, $ch_cs); msgx('<p><img src='.$img.' id="sndimg"></p>'); } } $tmp = explode(",",$opt); $url = str_replace('"','',$tmp[4]); if ($ex_type == $ex_radiko || $ex_type == $ex_timefree) { $nw = explode(",",$nowarea); $area = $nw[0]; $channel = $para[6]; $auth_token = rfriends_auth_audio($ex_type,$area,$channel); if ($auth_token === false) { echo_msg(2,"auth error"); exit; } ht_exaudio($url,$auth_token,""); } else { ht_exaudio($url,"",""); } exit; } $nam = "rfriends_exec_live"; if ($auto == 1) { echo_msg(2,$para[6]); echo_msg(2,$para[7]); echo_msg(2,$para[8]); } $ex = "ex_rfriends"; rfgw_batsh_sub($scrdir, $ex, $opt, 1, 1); return true; } function rfriends_live_radiko($ex_type,$para,$flg) { global $area_code; global $tmpdir; global $premium; global $user_auth; $channel = $para[6]; $mode = rf_premium_mode($area_code,$channel); $authtoken = rfriends_auth_radiko($mode,$area_code,0); if (is_null($authtoken)) { echo_prn(1, "radiko_auth error (プレミアム : $mode)"); return false; } $mode2 = $mode; if ($premium == 2) $mode2 = 0; $hlsurl = get_radiko_stream_url($channel, $tmpdir, $mode2); if ($hlsurl == "") { echo_msg(2, "stream_url not found (not delivered)"); return false; } $opt = "14 \"1,$channel,$flg,$authtoken,$hlsurl\""; return $opt; } function rfriends_live_timefree($ex_type,$para,$flg,$org) { global $area_code; global $tmpdir; global $premium; global $user_auth; $opt_fn = make_fn("playtf"); $recfiletmp = $tmpdir.$opt_fn; $fromtime = $para[0]; $totime = $para[1]; $channel = $para[6]; $mode = rf_premium_mode($area_code,$channel); $authtoken = rfriends_auth_radiko($mode,$area_code,0); if (is_null($authtoken)) { echo_prn(1, "radiko_auth error (プレミアム : $mode)"); return false; } $hlsurl = get_timefree_stream_url($channel, $fromtime, $totime, $recfiletmp, $authtoken,$org); if ($hlsurl == "") { echo_msg(2, "stream_url not found (not delivered)"); return false; } $channel = "timefree[$channel]"; $opt = "14 \"1,$channel,$flg,$authtoken,$hlsurl\""; return $opt; } function rfriends_live_radiru($ex_type,$para,$flg) { global $scrdir; $channel = $para[6]; $hlsurl = radiru_hls_url($channel); if ($hlsurl == null) { return false; } $opt = "14 \"2,$channel,$flg,,$hlsurl\""; return $opt; } function rfriends_live_radiru_vod($ex_type,$para,$flg) { global $scrdir; $channel = $para[6]; $hlsurl = $para[11]; if ($hlsurl == null) { return false; } $channel = "radiru_vod[$channel]"; $opt = "14 \"2,$channel,$flg,,$hlsurl\""; return $opt; } function rfriends_live_podcast($ex_type,$para,$flg) { global $scrdir; $channel = $para[6]; $hlsurl = $para[11]; if ($hlsurl == null) { return false; } $channel = "podcast[$channel]"; $opt = "14 \"2,$channel,$flg,,$hlsurl\""; return $opt; } 