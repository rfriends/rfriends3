<?php
 require_once("rf_inc.php"); require_once("rf_reserve.php"); require_once("rf_radiru.php"); require_once("rf_menu_sub.php"); $rfriends_mes = "ラジオ録音ツール"; $test_mode = 0; $msg_level = 1; $dt0 = 0; $n_k = $radiko_reserve_daily; $n_r = $radiru_reserve_daily; if ($argc >= 2) { $p = explode(",", $argv[1]); if (count_73($p) == 5) { $test_mode = $p[0]; $msg_level = $p[1]; $dt0 = $p[2]; $n_k = $p[3]; $n_r = $p[4]; } } $ex_type = $ex_radiru; $nr = $n_r; if ($nr < 1) { $nr = 1; } if ($nr > 7) { $nr = 7; } $nr2 = $nr * 24; $nw = time(); $fr_nw = $nw + $s_mkoffs; $to_nw = $fr_nw + $nr*24*3600; $ret = rf_program_date($ex_type, $fr_nw, $to_nw); $dt = $ret[0]; $cnt = $ret[1]; if ($test_mode == 1) { echo_prn(1, "--------------------"); echo_prn(1, "番組予約リスト"); echo_prn(1, "--------------------"); } rf_system_info($ex_radiru); $st_tm = start_prn(1, "Radiru Start(1.21)"); echo_prn(1, ""); echo_prn(1, str_repeat("-", 60)); echo_prn(1, "番組表更新 start"); echo_prn(1, "");; $pgmcnt = 8; $pgmdt = time(); $pgmdt1 = strtotime("0 day", $pgmdt); $pgmdt2 = strtotime("7 day", $pgmdt); $pgmymd1 = date("Y/m/d",$pgmdt1); $pgmymd2 = date("Y/m/d",$pgmdt2); $url_xml = rf_get_config_radiru(); $areakey = $url_xml["$radiru_area_1"]->areakey; foreach ($radiru_ch as $netch) { if (!valid_chk($ex_radiru, $netch)) { continue; } echo_prn(1, "radiru($areakey,$netch) $pgmymd1 - $pgmymd2 ($pgmcnt days)"); rf_program_radiru($pgmdt,$pgmcnt,$areakey, $netch); } echo_prn(1, ""); echo_prn(1, "番組表更新 end"); echo_prn(1, str_repeat("-", 60)); $reserve = $base."script".$DS."rfriends_reserve.php"; start_prn(1, "RadiruReserve Start  $cnt day(s)"); echo_prn(1, ""); $key = "radiru_ng_station"; $kw2 = rf_get_keyword($key); echo_prn(1, "radiru_ng_station :"); echo_prn(1, ""); foreach ($kw2 as $val) { echo_prn(1, " $val"); } echo_prn(1, ""); $key = "radiru_ng_program"; $kw2 = rf_get_keyword($key); echo_prn(1, "Radiru_ng_program :"); echo_prn(1, ""); foreach ($kw2 as $val) { echo_prn(1, " $val"); } $radiru_area_1 = rf_get_radiru_main_station(0); $secmes = "Radiru メインエリア : $radiru_area_1"; rf_disp_section($secmes, "+"); echo_prn(2, ""); $kwdat_ng = merge_keyword($ex_radiru,1); $kwdat = merge_keyword($ex_radiru,0); echo_prn(2, ""); $rsvdata = radiru_rsv_ex($kwdat, $kwdat_ng, $dt, $cnt, $nr2, $radiru_area_1, $radiru_ch); echo_prn(2, "reserve data count : ".count_73($rsvdata)); $kw = "radiru_ng_program"; $lines = rf_get_keyword($kw); $nlines = count_73($lines); echo_prn(2, str_repeat("-", 40)); echo_prn(2, "$kw kw : $nlines"); $ncnt = 0; if ($nlines > 0) { foreach($lines as $line) { echo_prn(2, "kw : $line"); $rsvdata_new = array(); foreach($rsvdata as $wdat) { $para = get_para($wdat,$ex_type); if ($para[7] != $line) { $rsvdata_new[] = $wdat; } else { radiru_disp("remove",$para,$ex_type); $ncnt++; } } $rsvdata = $rsvdata_new; } } echo_prn(2, ""); echo_prn(2, "radiru_ng_program remove count : $ncnt"); echo_prn(2, str_repeat("-", 40)); $kw = "duplicate program"; $rsvdata_sel = array(); foreach($rsvdata as $wdat) { $para = get_para($wdat,$ex_type); $rsvdata_sel[] = $para[0]." ".$para[1]." ".$para[2]." ".$para[7]; } $vcount = array_count_values($rsvdata_sel); $ncnt =0; foreach($vcount as $key => $value) { if ($value > 1) { $js = array_keys($rsvdata_sel,$key); for ($i=1;$i<count_73($js); $i++) { $j = $js[$i]; $para = get_para($rsvdata[$j],$ex_type); radiru_disp("remove",$para,$ex_type); unset($rsvdata[$j]); $ncnt++; } } } $rsvdata = array_values($rsvdata); echo_prn(2, ""); echo_prn(2, "duplicate program remove count : $ncnt"); echo_prn(2, str_repeat("-", 40)); rf_ex_reserve($test_mode, $ex_type, $rsvdata, $fr_nw, $to_nw); $lines = rf_get_keyword('radiru_timerec'); if (count_73($lines) > 0) { $station = rf_radiru_station_all(); $rsvdata = rf_timerec($area_code, $test_mode, $ex_type, $nw, $lines, $station); rf_ex_reserve($test_mode, $ex_type, $rsvdata, $fr_nw, $to_nw); } start_prn(1, "RadiruReserve End"); $ex_type = $ex_radiru; start_prn(1, "RadiruOtherAreaReserve Start $n_r hour(s)"); $other_station = rf_get_radiru_station(); foreach ($other_station as $area) { $kwdat_ng = array(); $kwdat = rf_get_keyword("radiru_$area"); $secmes = "Radiru サブエリア : $area"; rf_disp_section($secmes, "+"); echo_prn(2, ""); prt_kwcnt("radiru_$area",$kwdat); echo_prn(2, ""); $rsvdata = radiru_rsv_ex($kwdat,$kwdat_ng, $dt, $cnt, $nr2, $area, $radiru_ch_2); echo_prn(0, "reserve data count : ".count_73($rsvdata)); rf_ex_reserve($test_mode, $ex_type, $rsvdata, $fr_nw, $to_nw); $lines = rf_get_keyword("radiru_timerec_$area"); if (count_73($lines) > 0) { $station = rf_radiru_station_all(); $rsvdata = rf_timerec($area_code, $test_mode, $ex_type, $nw, $lines, $station); rf_ex_reserve($test_mode, $ex_type, $rsvdata, $fr_nw, $to_nw); } } start_prn(1, "RadiruOtherAreaReserve End"); $en_tm = start_prn(1, "Radiru End"); rf_statistics($st_tm, $en_tm); exit; 