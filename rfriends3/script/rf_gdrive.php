<?php
 function gdrive_check() { global $DS; $pt = rfgw_gdrive_path(); $token = $pt.$DS.".gdrive".$DS."token_v2.json"; echo_prn(1, "token:[$token]"); if (!file_exists($token)) { return false; } return true; } function gdrive_cancel() { global $DS; $pt = rfgw_gdrive_path(); $token = $pt.$DS.".gdrive".$DS."token_v2.json"; echo_prn(1, "token:[$token]"); if (file_exists($token)) { unlink($token); } return true; } function gdrive_get_id($pid, $dir) { global $DS; if ($pid == "") { $pt = ""; $ab = "--absolute"; } else { $pt = "'$pid' in parents and"; $ab = ""; } $ex_cmd = "gdrive list --no-header $ab --query \"$pt name = '$dir' and trashed = false " ."and mimeType = 'application/vnd.google-apps.folder'\""; $ret = external_exec_program($ex_cmd); if ($ret === false) { return false; } $n = count_73($ret); $m = 0; foreach ($ret as $str) { $r = preg_replace('/\s(?=\s)/', '', $str); $id_dir = explode(" ", $r); if (count_73($id_dir) != 5) { continue; } if ($id_dir[2] != "dir") { continue; } if ($id_dir[1] != $dir) { continue; } $id = $id_dir[0]; $m++; } if ($m == 0) { return ""; } if ($m != 1) { $pid2 = $pid; if ($pid2 == "") { $pid2 = "マイドライブ"; } echo_prn(1, "gdrive_get_id ($m times $dir in $pid2)"); return false; } return $id; } function gdrive_upload($pid, $fr, $ext) { if ($pid == "") { $pt = ""; } else { $pt = "--parent \"$pid\""; } $ex_cmd = "gdrive upload $pt \"$fr.$ext\" --no-progress"; echo_prn(1, $ex_cmd); $ret = external_exec_program($ex_cmd); if ($ret === false) { echo_prn(1, "gdrive upload error ($fr.$ext)"); return false; } return true; } function gdrive_make_dir($pid, $dir) { if ($pid == "") { $ex_cmd = "gdrive mkdir $dir"; } else { $ex_cmd = "gdrive mkdir -p $pid $dir"; } $ret = external_exec_program($ex_cmd); if ($ret === false) { echo_prn(1, "$pid,$dir ディレクトリの作成に失敗しました。"); return false; } echo_prn(1, "$pid,$dir ディレクトリを作成しました。"); return $ret; } function rf_gdrive_upload_file($rdr, $dir, $fil, $ext) { $ret = gdrive_check(); if ($ret === false) { echo_prn(1, "GoogleDriveの認証が済んでいません。"); return false; } $rid = gdrive_get_id("", $rdr); if ($rid === false || $rid == "") { echo_prn(1, "$rdr ディレクトリが異常です。"); return false; } $pid = gdrive_get_id($rid, $dir); if ($pid === false || $pid == "") { echo_prn(1, "$dir ディレクトリが異常です。"); return false; } $ret = gdrive_upload($pid, $fil, $ext); if ($ret === false) { echo_prn(1, "$fil.$ext のアップロードに失敗しました。"); return false; } return true; } 